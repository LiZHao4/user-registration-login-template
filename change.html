<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>更改信息</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body class="flex">
		<div class="form">
			<h2>修改信息</h2>
			<div class="pop2" id="pop2">
				<label for="pass">　　密码：</label><input type="password" id="pass" /><br />
				<label for="repass">确认密码：</label><input type="password" id="repass" />
				<div class="buttons">
					<button class="b" id="no">关闭</button>
					<button class="main-button" id="ok">确定</button>
				</div>
			</div>
			<table>
				<tr>
					<td class="table"><img id="avatar" class="avatar2" src="default.jpg"><br><div class="gray">点击头像以修改头像</div></td>
					<td class="table">
						<span class="t"><label>用户名：</label><span id="user"></span></span><br />
						<span class="t"><label for="nick">　昵称：</label><input type="text" id="nick" placeholder="请输入昵称" class="text" /></span>
					</td>
				</tr>
				<tr>
					<td class="table">
						<span class="t">
							<label for="user">性别：</label>
							<select id="gender" class="selection">
								<option value="M">男</option>
								<option value="W">女</option>
								<option value="N">不设置</option>
							</select>
						</span>
					</td>
					<td class="table">
						<span class="t">
							<label for="user">生日：</label>
							<input type="date" id="birth" class="selection1" />
						</span>
					</td>
				</tr>
				<tr>
					<td colspan="2" class="table">
						<label for="bio">个性签名：</label><br><textarea id="bio" class="bio" placeholder="请输入个性签名" wrap="hard" maxlength="250"></textarea>
					</td>
				</tr>
			</table>
			<div class="buttons">
				<button class="b" id="changepass">修改密码</button>
				<button class="b" id="del">注销账户</button>
				<button class="main-button" id="save">保存</button>
			</div>
		</div>
		<input type="file" class="hidden" id="fileInput" accept="image/jpeg, image/png">
		<script src="js/lib.js"></script>
		<script>
			var isPopupVisible = false, conf = {}, nconf = {};
			window.onload = function() {
				var token = getCookie('_');
				if (!token) {
					location.href = 'login.html';
				}
				var params = new URLSearchParams({
					token: token,
					v: '2'
				});
				var xhr = new XMLHttpRequest();
				xhr.open('POST', 'user_data2.php', true);
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.onreadystatechange = function() {
					if (xhr.readyState === 4 && xhr.status === 200) {
						var response = JSON.parse(xhr.responseText);
						if (response.code === 1) {
							conf = response.data;
							document.getElementById('user').innerText = conf.user;
							document.getElementById('nick').value = conf.nick;
							if (conf.avatar) document.getElementById('avatar').src = 'avatar/' + conf.token + '.jpg';
							document.getElementById('gender').value = conf.gender;
							document.getElementById('birth').value = conf.birth;
							document.getElementById('bio').value = conf.bio;
						} else {
							showPop(response.msg);
						}
					}
				};
				xhr.send(params.toString());
			};
			document.getElementById('changepass').addEventListener('click', togglePopupVisibility);
			document.getElementById('no').addEventListener('click', togglePopupVisibility);
			document.getElementById('save').addEventListener('click', function() {
				if (conf.nick !== document.getElementById('nick').value.trim()) {
					var newNickname = document.getElementById('nick').value.trim();
					if (!newNickname) {
						showPop('昵称不能为空。');
						return;
					}
					nconf.nick = newNickname;
				}
				if (conf.gender !== document.getElementById('gender').value) {
					nconf.gender = document.getElementById('gender').value;
				}
				if (conf.birth !== document.getElementById('birth').value) {
					if (testFuture(new Date(document.getElementById('birth').value))) {
						showPop('出生日期不能是未来的日期。');
						return;
					}
					nconf.birth = document.getElementById('birth').value;
				}
				if (conf.bio !== document.getElementById('bio').value) {
					nconf.bio = document.getElementById('bio').value.trim();
				}
				if (Object.keys(nconf).length === 0) {
					showPop2('用户信息未修改。', [{text: '回到主页', fn: function() {
						location.href = "index.html";
					}}]);
					return;
				}
				var saveParams = new URLSearchParams({p:JSON.stringify(nconf),id:conf.id,token:conf.token,v:'2'});
				var xhrSave = new XMLHttpRequest();
				xhrSave.open('POST', 'save.php', true);
				xhrSave.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhrSave.onreadystatechange = function() {
					if (xhrSave.readyState === 4 && xhrSave.status === 200) {
						var response = JSON.parse(xhrSave.responseText);
						if (response.code === 1) {
							location.href = "index.html";
						} else if (response.code === 0) {
							showPop2(response.msg, [{text: '重新登录', fn: function () {
								location.href = "login.html";
							}}]);
						} else {
							showPop(response.msg);
						}
					}
				};
				xhrSave.send(saveParams);
			});
			document.getElementById('ok').addEventListener('click', function() {
				if (checkPassword(document.getElementById('pass').value, document.getElementById('repass').value)) {
					nconf.pass = document.getElementById('pass').value;
					showPop('密码已保存。点击页面上的“保存”按钮可修改密码。');
				} else {
					showPop('密码不符合要求，请重新输入。');
				}
			});
			document.getElementById('del').addEventListener('click', function() {
				var confirmDeletion = showPop2("你确定要注销账户吗？注销账户后，你就再也无法登录本账户。", [{text: '确定', fn: function() {
				    var accountId = conf.id;
					var queryParams = new URLSearchParams({
						id: accountId,
						token: conf.token,
						v: '2'
					});
					var xhrRequest = new XMLHttpRequest();
					xhrRequest.open('POST', 'del.php', true);
					xhrRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
					xhrRequest.onreadystatechange = function() {
						if (xhrRequest.readyState === 4 && xhrRequest.status === 200) {
							var responseText = JSON.parse(xhrRequest.responseText);
							if (responseText.code === 0 || responseText.code === 1) {
								showPop2(responseText.msg, [{text: '重新登录', fn: function() {
								    location.href = "login.html";
								}}]);
							} else {
								showPop(responseText.msg);
							}
						}
					};
					xhrRequest.send(queryParams.toString());
				}}, {text: '取消'}]);
			});
			document.getElementById('avatar').addEventListener('click', function() {
				document.getElementById('fileInput').click();
			});
			document.getElementById('fileInput').addEventListener('change', function(event) {
				var selectedFile = event.target.files[0];
				if (!selectedFile) return;
				var fileExtension = selectedFile.name.split('.').pop().toLowerCase();
				if (fileExtension !== 'jpg' && fileExtension !== 'png') {
					alert('上传的图片格式只支持jpg或png');
					return;
				}
				var formData = new FormData();
				formData.append('avatar', document.getElementById('fileInput').files[0]);
				formData.append('id', conf.id);
				formData.append('token', conf.token);
				formData.append('v', '2');
				var httpReq = new XMLHttpRequest();
				httpReq.open('POST', 'avatar.php', true);
				httpReq.onload = function () {
					if (httpReq.readyState === 4 && httpReq.status === 200) {
						var serverResponse = JSON.parse(httpReq.responseText);
						if (serverResponse.code === 1) {
							document.getElementById('avatar').setAttribute('src', 'avatar/' + conf.token + '.jpg');
							showPop(serverResponse.msg);
						} else if (serverResponse.code === 0) {
							showPop2(serverResponse.msg, [{text: '重新登录', fn: function () {
								location.href = "login.html";
							}}]);
						} else {
							showPop(serverResponse.msg);
						}
					}
				};
				httpReq.send(formData);
			});
		</script>
	</body>
</html>