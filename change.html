<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>更改信息</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body class="flex">
		<div id="form">
			<h2>修改信息</h2>
			<div id="pop2">
				<label for="pass">　　密码：</label><input type="password" id="pass" /><br />
				<label for="repass">确认密码：</label><input type="password" id="repass" />
				<div class="buttons">
					<button class="b" id="no">关闭</button>
					<button id="ok">确定</button>
				</div>
			</div>
			<table>
				<tr>
					<td class="table"><img id="avatar2" src="default.jpg"><br>点击头像以修改头像</td>
					<td class="table">
						<span class="t"><label>用户名：</label><span id="user"></span></span><br />
						<span class="t"><label for="nick">　昵称：</label><input type="text" id="nick" placeholder="请输入昵称" class="text" /></span>
					</td>
				</tr>
				<tr>
					<td class="table">
						<span class="t">
							<label for="user">性别：</label>
							<select id="gender" class="selection">
								<option value="M">男</option>
								<option value="W">女</option>
								<option value="N">不设置</option>
							</select>
						</span>
					</td>
					<td class="table">
						<span class="t">
							<label for="user">生日：</label>
							<input type="date" id="birth" class="selection1" />
						</span>
					</td>
				</tr>
				<tr>
					<td colspan="2" class="table">
						<label for="bio">个性签名：</label><br><textarea id="bio" class="bio" placeholder="请输入个性签名" wrap="hard" maxlength="250"></textarea>
					</td>
				</tr>
			</table>
			<div class="buttons">
				<button class="b" id="changepass">修改密码</button>
				<button class="b" id="del">注销账户</button>
				<button id="save">保存</button>
			</div>
		</div>
		<input type="file" id="fileInput" accept="image/jpeg, image/png">
		<script>
			var userData, isPopupVisible = false, conf = {}, nconf = {};
			function togglePopupVisibility() {
				if (isPopupVisible) {
					document.getElementById('pop2').style.visibility = 'hidden';
					isPopupVisible = false;
				} else {
					document.getElementById('pop2').style.visibility = 'visible';
					isPopupVisible = true;
				}
			}
			function getCookie(name) {
				var value = `; ${document.cookie}`;
				var parts = value.split(`; ${name}=`);
				if (parts.length === 2) return parts.pop().split(';').shift();
				return null;
			}
			function checkPassword(password, repassword) {
				return password === repassword && !!password && !(password.length < 8 || 32 < password.length || !/[a-z]/.test(password) || !/[A-Z]/.test(password) || !/\d/.test(password));
			}
			function testFuture(date) {
				return new Date(date) > new Date();
			}
			window.onload = function() {
				var token = getCookie('_');
				if (!token) {
					location.href = 'login.html';
				}
				var params = new URLSearchParams({
					token: token
				});
				var xhr = new XMLHttpRequest();
				xhr.open('POST', 'user_data2.php', true);
				xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhr.onreadystatechange = function() {
					if (xhr.readyState === 4 && xhr.status === 200) {
						var response = xhr.responseText;
						if (response) {
							if (response === 'invalid') {
								alert('用户信息被篡改，无法查看信息。');
								location.href = 'login.html';
							}
							userData = response.split('\n');
							document.getElementById('user').innerText = userData[0];
							document.getElementById('nick').value = conf['nick'] = userData[1];
							if (userData[3] === '1') {
								document.getElementById('avatar2').src = 'avatar/' + userData[4] + '.jpg';
							}
							document.getElementById('gender').value = conf['gender'] = userData[5];
							document.getElementById('birth').value = conf['birth'] = userData[6];
							document.getElementById('bio').value = conf['bio'] = userData[7];
						} else {
							alert('查询失败，请稍后再试。');
						}
					}
				};
				xhr.send(params.toString());
			};
			document.getElementById('changepass').addEventListener('click', togglePopupVisibility);
			document.getElementById('no').addEventListener('click', togglePopupVisibility);
			document.getElementById('save').addEventListener('click', function() {
				if (conf['nick'] !== document.getElementById('nick').value.trim()) {
					var newNickname = document.getElementById('nick').value.trim();
					if (!newNickname) {
						alert('昵称不能为空。');
						return;
					}
					nconf['nick'] = newNickname;
				}
				if (conf['gender'] !== document.getElementById('gender').value) {
					nconf['gender'] = document.getElementById('gender').value;
				}
				if (conf['birth'] !== document.getElementById('birth').value) {
					if (testFuture(new Date(document.getElementById('birth').value))) {
						alert('出生日期不能是未来的日期。');
						return;
					}
					nconf['birth'] = document.getElementById('birth').value;
				}
				if (conf['bio'] !== document.getElementById('bio').value) {
					nconf['bio'] = document.getElementById('bio').value.trim();
				}
				if (Object.keys(nconf).length === 0) {
					alert('用户信息未修改。');
					location.href = "index.html";
					return;
				}
				var saveParams = new URLSearchParams({p:JSON.stringify(nconf),id:userData[2],token:userData[4]});
				var xhrSave = new XMLHttpRequest();
				xhrSave.open('POST', 'save.php', true);
				xhrSave.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
				xhrSave.onreadystatechange = function() {
					if (xhrSave.readyState === 4 && xhrSave.status === 200) {
						var response = xhrSave.responseText;
						if (response === "fail") {
							alert('修改失败，请稍后再试！');
						} else if (response === "success") {
							alert('修改成功！');
							location.href = "index.html";
						} else {
							alert(response);
						}
					}
				};
				xhrSave.send(saveParams);
			});
			document.getElementById('ok').addEventListener('click', function() {
				if (checkPassword(document.getElementById('pass').value, document.getElementById('repass').value)) {
					nconf['pass'] = document.getElementById('pass').value;
					alert('密码已保存。点击页面上的“保存”按钮可修改密码。');
				} else {
					alert('密码不符合要求，请重新输入。');
				}
			});
			document.getElementById('del').addEventListener('click', function() {
				var confirmDeletion = confirm("你确定要注销账户吗？注销账户后，你就再也无法登录本账户。");
				if (confirmDeletion) {
					var accountId = userData[2];
					var queryParams = new URLSearchParams({
						id: accountId,
						token: userData[4]
					});
					var xhrRequest = new XMLHttpRequest();
					xhrRequest.open('POST', 'del.php', true);
					xhrRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
					xhrRequest.onreadystatechange = function() {
						if (xhrRequest.readyState === 4 && xhrRequest.status === 200) {
							var responseText = xhrRequest.responseText;
							if (responseText === "fail") {
								alert('注销失败，请稍后再试！');
							} else if (responseText === "success") {
								alert('注销成功！');
								localStorage.removeItem('_');
								location.href = "login.html";
							}
						}
					};
					xhrRequest.send(queryParams.toString());
				}
			});
			document.getElementById('avatar2').addEventListener('click', function() {
				document.getElementById('fileInput').click();
			});
			document.getElementById('fileInput').addEventListener('change', function(event) {
				var selectedFile = event.target.files[0];
				if (!selectedFile) return;
				var fileExtension = selectedFile.name.split('.').pop().toLowerCase();
				if (fileExtension !== 'jpg' && fileExtension !== 'png') {
					alert('上传的图片格式只支持jpg或png');
					return;
				}
				var formData = new FormData();
				formData.append('avatar', document.getElementById('fileInput').files[0]);
				formData.append('id', userData[2]);
				var httpReq = new XMLHttpRequest();
				httpReq.open('POST', 'avatar.php', true);
				httpReq.onload = function () {
					if (httpReq.readyState === 4 && httpReq.status === 200) {
						var serverResponse = httpReq.responseText;
						if (serverResponse == 'success') {
							document.getElementById('avatar2').setAttribute('src', 'avatar/' + userData[4] + '.jpg');
						} else if (serverResponse == 'fail') {
							alert('头像修改失败，请稍后再试。');
						}
					}
				};
				httpReq.send(formData);
			});
		</script>
	</body>
</html>